<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Historial de Servicios</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <style>
        :root{
            --bg:#F8EDE3; --surface:#ffffff; --tone-2:#DFD3C3; --tone-3:#D0B8A8; --brand:#C5705D;
            --text:#3b2f2f; --ring:rgba(197,112,93,.35);
            --ok:#1f9d65; --warn:#b58400; --err:#b42318; --info:#3b82f6;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}

        /* NAV */
        .nav{background:linear-gradient(180deg,var(--bg),var(--tone-2));border-bottom:1px solid rgba(0,0,0,.05)}
        .nav-inner{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center}
        .se-brand{font-weight:800;letter-spacing:.2px;color:var(--brand);text-decoration:none;font-size:20px}
        .nav-spacer{flex:1}
        .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:16px;
            background:#fff;border:1px solid var(--tone-2);text-decoration:none;color:var(--text);
            box-shadow:0 3px 10px rgba(0,0,0,.06);font-weight:700}
        .pill.primary{background:var(--brand);border-color:var(--brand);color:#fff}

        /* CARD + TABLE */
        .wrap{max-width:1100px;margin:28px auto;padding:20px;background:var(--surface);border:1px solid var(--tone-2);
            border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
        h2{margin:4px 0 18px;text-align:center}
        table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
        th,td{padding:12px;border:1px solid #efdfd7;text-align:left}
        th{background:var(--tone-2)}
        tbody tr:nth-child(odd){background:#fbf7f3}
        .actions{white-space:nowrap}

        /* Estados */
        .estado{font-weight:800;text-transform:uppercase}
        .estado.PAGO_EN_PROCESO{color:var(--warn)}
        .estado.PAGO_ACEPTADO{color:var(--ok)}
        .estado.PAGO_RECHAZADO{color:var(--err)}
        .estado.ACEPTADA{color:var(--ok)}
        .estado.RECHAZADA{color:var(--err)}
        .estado.CANCELADA{color:#d97706}
        .estado.COMPLETADA{color:var(--info)}

        /* Botones */
        .btn{display:inline-block;padding:8px 14px;border-radius:10px;font-weight:700;border:none;cursor:pointer}
        .btn.primary{background:#c77462;color:#fff}.btn.primary:hover{filter:brightness(.95)}
        .btn.secondary{background:#95a5a6;color:#fff}.btn.secondary:hover{background:#7f8c8d}
        .btn.ghost{background:#fff;border:1px solid var(--tone-2);color:var(--text)}
        .btn.danger{background:#e74c3c;color:#fff}.btn.danger:hover{background:#c0392b}

        /* Modal simple */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:1000}
        .modal-box{width:min(480px,92vw);margin:10% auto;background:#fff;border-radius:14px;border:1px solid var(--tone-2);
            box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden}
        .modal-head{padding:14px 16px;background:var(--tone-2);font-weight:800}
        .modal-body{padding:16px}
        .modal-foot{padding:12px 16px;display:flex;gap:10px;justify-content:flex-end;background:#faf6f2}
        select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--tone-3);font:inherit}
        select:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 .2rem var(--ring)}
    </style>
    <script>
        function abrir(id){ document.getElementById('m-'+id).style.display='block' }
        function cerrar(id){ document.getElementById('m-'+id).style.display='none' }
    </script>
</head>
<body>

<!-- NAV -->
<header class="nav">
    <div class="nav-inner">
        <a class="se-brand" th:href="@{/}">ServiExpress</a>
        <div class="nav-spacer"></div>

        <!-- Si es ADMIN, mostrar ir/volver -->
        <a th:if="${session.usuarioSesion != null and session.usuarioSesion.rol != null and session.usuarioSesion.rol.rol == 'ADMIN'}"
           th:href="@{/Admins/servicios}" class="pill">⬅ Gestionar Servicios</a>

        <!-- Si NO es admin, tus atajos originales si los necesitas -->
        <a th:if="${!(session.usuarioSesion != null and session.usuarioSesion.rol != null and session.usuarioSesion.rol.rol == 'ADMIN')}"
           th:href="@{|/Proveedores/${idProveedor}/solicitudesPendientes|}" class="pill">Solicitudes pendientes</a>
        <a th:if="${!(session.usuarioSesion != null and session.usuarioSesion.rol != null and session.usuarioSesion.rol.rol == 'ADMIN')}"
           th:href="@{|/Proveedores/${idProveedor}/publicarServicio|}" class="pill">Publicar servicios</a>
    </div>
</header>

<main class="wrap">
    <h2>Historial de Servicios</h2>

    <div th:if="${#lists.isEmpty(historialServicios)}">
        <p>No tienes servicios en el historial.</p>
    </div>

    <div th:if="${!#lists.isEmpty(historialServicios)}">
        <table>
            <thead>
            <tr>
                <th>ID</th>
                <th>Servicio</th>
                <th>Descripción</th>
                <th>Cliente</th>
                <th>Precio</th>
                <th>Estado</th>
                <th class="actions"
                    th:if="${session.usuarioSesion != null and session.usuarioSesion.rol != null and session.usuarioSesion.rol.rol == 'ADMIN'}">
                    Acciones
                </th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="servicio : ${historialServicios}">
                <td th:text="${servicio.idServicio}">1</td>
                <td th:text="${servicio.nombre}">Servicio</td>
                <td th:text="${servicio.descripcion}">Desc</td>
                <td th:text="${servicio.cliente != null ? servicio.cliente.nombre : '---'}">Cliente</td>
                <td th:text="${servicio.precio}">0</td>
                <td th:text="${servicio.estado}" th:class="'estado ' + ${servicio.estado}">ESTADO</td>

                <!-- Botón editar solo ADMIN -->
                <td class="actions"
                    th:if="${session.usuarioSesion != null and session.usuarioSesion.rol != null and session.usuarioSesion.rol.rol == 'ADMIN'}">
                    <button type="button" class="btn primary" th:onclick="'abrir(' + ${servicio.idServicio} + ')'">Editar estado</button>

                    <!-- MODAL -->
                    <div class="modal" th:id="${'m-' + servicio.idServicio}">
                        <div class="modal-box">
                            <div class="modal-head">Cambiar estado del servicio #<span th:text="${servicio.idServicio}">1</span></div>
                            <div class="modal-body">
                                <form th:action="@{'/Admins/servicios/' + ${servicio.idServicio} + '/estado'}" method="post">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                    <label for="estado" style="font-weight:700;display:block;margin-bottom:6px">Nuevo estado</label>
                                    <select id="estado" name="estado" required>
                                        <option value="PAGO_EN_PROCESO">PAGO_EN_PROCESO</option>
                                        <option value="PAGO_ACEPTADO">PAGO_ACEPTADO</option>
                                        <option value="PAGO_RECHAZADO">PAGO_RECHAZADO</option>
                                    </select>
                                    <div class="modal-foot">
                                        <button type="button" class="btn ghost" th:onclick="'cerrar(' + ${servicio.idServicio} + ')'">Cerrar</button>
                                        <button type="submit" class="btn primary">Guardar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- /MODAL -->
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

</body>
</html>