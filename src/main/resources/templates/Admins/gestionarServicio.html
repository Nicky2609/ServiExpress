<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${title} ?: 'GestiÃ³n de Servicios (Admin)'">GestiÃ³n de Servicios (Admin)</title>

    <!-- Fuente unificada -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap y (si tienes) tu hoja global -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/styles.css}">

    <style>
        :root{
          /* Paleta terracota / crema */
          --bg:#F8EDE3; --tone-2:#DFD3C3; --tone-3:#D0B8A8; --brand:#C5705D;
          --brand-600:#a85848; --text:#3b2f2f; --surface:#ffffff; --ring:rgba(197,112,93,.35);
          --line:#e6d7ce;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          background:var(--bg);
          color:var(--text);
          font-family:Poppins, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }

        /* ===== NAVBAR ===== */
        .se-nav{
          position:sticky; top:0; z-index:50;
          background:linear-gradient(90deg,var(--bg),var(--tone-2));
          border-bottom:1px solid var(--line);
          backdrop-filter:saturate(1.1) blur(4px);
        }
        .se-brand{
          font-weight:800; letter-spacing:.2px; color:var(--brand-600)!important; text-decoration:none; font-size:20px;
        }
        .se-chip{
          background:var(--surface); border:1px solid var(--tone-2); border-radius:999px;
          padding:.55rem .95rem; box-shadow:0 6px 16px rgba(0,0,0,.06); font-weight:700;
        }
        .btn-brand{ background:var(--brand); border-color:var(--brand); color:#fff; }
        .btn-brand:hover{ filter:brightness(.96); color:#fff; }
        .btn-ghost{ background:var(--surface); border:1px solid var(--tone-2); color:var(--text); }
        .form-control:focus{ border-color:var(--brand)!important; box-shadow:0 0 0 .25rem var(--ring)!important; }

        /* ===== CARDS / CONTENIDO ===== */
        .se-card{
          background:var(--surface); border:1px solid var(--tone-2);
          border-radius:18px; padding:1.25rem; box-shadow:0 10px 28px rgba(0,0,0,.06);
        }

        /* ===== TABLA ===== */
        .table thead th{
          background:var(--tone-2)!important; color:#5a493f; border-bottom-color:var(--tone-2)!important; font-weight:800;
        }
        .table-striped>tbody>tr:nth-of-type(odd){ --bs-table-accent-bg: rgba(208,184,168,.12); }

        /* Modal backdrop */
        .modal-backdrop.show{ background:rgba(59,47,47,.55) }

        /* Cositas */
        .actions-gap{gap:.4rem}
    </style>
</head>
<body>

<!-- ===== NAV ===== -->
<nav class="se-nav py-3" role="navigation" aria-label="Principal">
    <div class="container d-flex align-items-center justify-content-between gap-3">
        <a class="se-brand" th:href="@{/}">ServiExpress</a>

        <div class="d-flex align-items-center actions-gap">
            <a th:href="@{/Admins/usuarios}" class="btn btn-ghost se-chip">Gestionar Usuarios</a>

            <!-- Historial (usa el controlador de solicitudes con detecciÃ³n de rol) -->
            <a th:href="@{/solicitud/historial}" class="btn btn-ghost se-chip">ðŸ“œ Ver Historial</a>

            <!-- Crear Servicio (ruta real del controlador) -->
            <a th:href="@{/servicio/crearServicio}" class="btn btn-brand se-chip">Crear Servicio</a>

            <!-- Logout (POST + CSRF) -->
            <form th:action="@{/auth/logout}" method="post" class="m-0 p-0">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <button class="btn btn-outline-danger se-chip" type="submit">Cerrar sesiÃ³n</button>
            </form>
        </div>
    </div>
</nav>

<main class="container my-4">
    <div class="d-flex align-items-end justify-content-between mb-3">
        <h1 class="m-0 fw-bold" th:text="${title} ?: 'GestiÃ³n de Servicios (Admin)'">GestiÃ³n de Servicios (Admin)</h1>

        <!-- Buscador en vivo -->
        <form class="d-flex" role="search" onsubmit="return false" aria-label="Buscar servicios">
            <input id="searchInput" type="search" class="form-control se-chip"
                   placeholder="Buscar por nombre, descripciÃ³n o precioâ€¦" autocomplete="off">
        </form>
    </div>

    <!-- Mensajes -->
    <div class="se-card mb-3">
        <div th:if="${mensajeExito}" class="alert alert-success mb-2" th:text="${mensajeExito}"></div>
        <div th:if="${success}" class="alert alert-success mb-2" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger mb-0" th:text="${error}"></div>
        <div th:if="${mensajeExito == null and success == null and error == null}" class="small text-muted">
            Tip: usa el buscador o el historial para revisar solicitudes y estados.
        </div>
    </div>

    <!-- Tabla -->
    <div class="se-card">
        <div class="table-responsive">
            <table class="table table-striped align-middle mb-0" id="tablaServicios">
                <thead>
                <tr>
                    <th style="min-width:90px">ID</th>
                    <th style="min-width:180px">Nombre</th>
                    <th>DescripciÃ³n</th>
                    <th style="min-width:120px">Precio</th>
                    <th class="text-end" style="min-width:160px">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="servicio : ${Servicios}">
                    <td th:text="${servicio.idServicio}">1</td>
                    <td th:text="${servicio.nombre}">Nombre</td>
                    <td th:text="${servicio.descripcion}">DescripciÃ³n</td>
                    <td th:text="${servicio.precio}">0.00</td>
                    <td class="text-end">
                        <div class="d-inline-flex gap-1">
                            <a th:href="@{'/Admins/servicios/' + ${servicio.idServicio} + '/editar'}"
                               class="btn btn-warning btn-sm">Editar</a>

                            <!-- Eliminar con confirmaciÃ³n modal -->
                            <button type="button"
                                    class="btn btn-danger btn-sm js-delete"
                                    th:data-action="@{'/Admins/servicios/' + ${servicio.idServicio} + '/eliminar'}">
                                Eliminar
                            </button>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(Servicios)}" data-empty-row>
                    <td colspan="5" class="text-center text-muted">No hay servicios</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Modal ConfirmaciÃ³n -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius:16px; overflow:hidden;">
            <div class="modal-header border-0" style="background:#DFD3C3;">
                <h5 id="confirmDeleteTitle" class="modal-title" style="color:#3b2f2f; font-weight:700;">Â¿Eliminar servicio?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" style="background:#F8EDE3; color:#3b2f2f;">
                <p class="mb-0">Esta acciÃ³n no se puede deshacer. Â¿Deseas continuar?</p>
            </div>
            <div class="modal-footer border-0" style="background:#F8EDE3;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <!-- Form maestro (POST + CSRF) -->
                <form id="confirmDeleteForm" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn btn-brand text-white">SÃ­, eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Filtro en vivo + Modal eliminaciÃ³n -->
<script>
    (function(){
      // Modal de confirmaciÃ³n
      const modalEl = document.getElementById('confirmDeleteModal');
      const form = document.getElementById('confirmDeleteForm');
      if(modalEl && form){
        const modal = new bootstrap.Modal(modalEl);
        document.querySelectorAll('.js-delete').forEach(btn => {
          btn.addEventListener('click', () => {
            form.setAttribute('action', btn.getAttribute('data-action'));
            modal.show();
          });
        });
      }

      // Filtro en vivo de la tabla
      const input = document.getElementById('searchInput');
      const table = document.getElementById('tablaServicios');
      if(!input || !table) return;

      const rows = table.querySelectorAll('tbody tr');
      const normalize = s => (s || '').toString().toLowerCase()
        .normalize('NFD').replace(/\p{Diacritic}/gu, '');

      function filter(q){
        const nquery = normalize(q);
        let any = false;
        rows.forEach(row => {
          const empty = row.hasAttribute('data-empty-row');
          if (empty) return;
          const cells = Array.from(row.querySelectorAll('td')).map(td => normalize(td.textContent));
          const match = cells.some(t => t.includes(nquery));
          row.style.display = match ? '' : 'none';
          if (match) any = true;
        });
        const emptyRow = table.querySelector('tbody tr[data-empty-row]');
        if (emptyRow) emptyRow.style.display = any ? 'none' : '';
      }

      input.addEventListener('input', e => filter(e.target.value));
      input.addEventListener('keydown', e => { if (e.key === 'Enter') e.preventDefault(); });
    })();
</script>
</body>
</html>