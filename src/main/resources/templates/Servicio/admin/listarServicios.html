<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="${title} ?: 'Servicios Disponibles'">Servicios Disponibles</title>

    <!-- Fuente Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        :root{
          --bg:#F8EDE3; --tone-2:#DFD3C3; --tone-3:#D0B8A8; --brand:#C5705D;
          --brand-600:#a85848; --text:#3b2f2f; --surface:#ffffff; --ring:rgba(197,112,93,.35);
          --line:#e6d7ce;
        }
        *{box-sizing:border-box}
        html,body{height:100%}
        body{
          background:var(--bg);
          color:var(--text);
          font-family:Poppins, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        }

        /* NAVBAR */
        .se-nav{
          position:sticky; top:0; z-index:50;
          background:linear-gradient(90deg,var(--bg),var(--tone-2));
          border-bottom:1px solid var(--line);
          backdrop-filter:saturate(1.1) blur(4px);
        }
        .se-brand{
          font-weight:800; letter-spacing:.2px; color:var(--brand-600)!important; text-decoration:none; font-size:20px;
        }
        .se-chip{
          background:var(--surface); border:1px solid var(--tone-2); border-radius:999px;
          padding:.55rem .95rem; box-shadow:0 6px 16px rgba(0,0,0,.06); font-weight:700;
        }
        .btn-brand{ background:var(--brand); border-color:var(--brand); color:#fff; }
        .btn-brand:hover{ filter:brightness(.96); color:#fff; }
        .btn-ghost{ background:var(--surface); border:1px solid var(--tone-2); color:var(--text); }
        .form-control:focus{ border-color:var(--brand)!important; box-shadow:0 0 0 .25rem var(--ring)!important; }

        /* CARD */
        .se-card{
          background:var(--surface); border:1px solid var(--tone-2);
          border-radius:18px; padding:1.25rem; box-shadow:0 10px 28px rgba(0,0,0,.06);
        }

        /* TABLA */
        .table thead th{
          background:var(--tone-2)!important; color:#5a493f; border-bottom-color:var(--tone-2)!important; font-weight:800;
        }
        .table-striped>tbody>tr:nth-of-type(odd){ --bs-table-accent-bg: rgba(208,184,168,.12); }

        .actions-gap{gap:.4rem}
    </style>
</head>
<body>

<!-- NAV -->
<nav class="se-nav py-3" role="navigation" aria-label="Principal">
    <div class="container d-flex align-items-center justify-content-between gap-3">
        <a class="se-brand" th:href="@{/}">ServiExpress</a>

        <div class="d-flex align-items-center actions-gap">
            <a th:href="@{/}" class="btn btn-ghost se-chip">Inicio</a>
            <a th:href="@{/servicio}" class="btn btn-ghost se-chip">Servicios</a>
            <a th:href="@{/auth/registro}" class="btn btn-brand se-chip">Registro</a>
        </div>
    </div>
</nav>

<main class="container my-4">
    <div class="d-flex align-items-end justify-content-between mb-3">
        <h1 class="m-0 fw-bold">Servicios Disponibles</h1>

        <!-- Buscador -->
        <form class="d-flex" role="search" onsubmit="return false">
            <input id="buscar" type="search" class="form-control se-chip"
                   placeholder="Buscar servicio…" autocomplete="off">
        </form>
    </div>

    <!-- Mensajes -->
    <div class="se-card mb-3">
        <div th:if="${success}" class="alert alert-success mb-2" th:text="${success}"></div>
        <div th:if="${error}" class="alert alert-danger mb-0" th:text="${error}"></div>
        <div th:if="${success == null and error == null}" class="small text-muted">
            Tip: usa el buscador para encontrar servicios fácilmente.
        </div>
    </div>

    <!-- Botón crear servicio -->
    <div class="mb-3" sec:authorize="hasAnyRole('ADMIN','PROVEEDOR')">
        <a class="btn btn-brand se-chip" th:href="@{/servicio/crearServicio}">+ Crear Nuevo Servicio</a>
    </div>

    <!-- Tabla -->
    <div class="se-card">
        <div class="table-responsive">
            <table class="table table-striped align-middle mb-0" id="tablaServicios">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Precio</th>
                    <th>Proveedor</th>
                    <th>Estado</th>
                    <th class="text-end">Acciones</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="servicio : ${servicios}">
                    <td th:text="${servicio.nombre}">Nombre</td>
                    <td th:text="${servicio.descripcion}">Descripción</td>
                    <td th:text="${servicio.precio}">0.00</td>
                    <td th:text="${servicio.proveedor != null ? servicio.proveedor.nombreUsuario : 'Sin asignar'}"></td>
                    <td th:text="${servicio.estado}"></td>
                    <td class="text-end">
                        <div sec:authorize="hasRole('ADMIN')">
                            <a th:href="@{/servicio/editar/{id}(id=${servicio.idServicio})}" class="btn btn-warning btn-sm">Editar</a>
                            <button type="button" class="btn btn-danger btn-sm js-delete"
                                    th:data-id="${servicio.idServicio}">Eliminar</button>
                        </div>
                        <div th:if="${rol == 'PROVEEDOR' and servicio.proveedor != null && servicio.proveedor.idUsuario == usuarioSesion.idUsuario}">
                            <a th:href="@{/servicio/editar/{id}(id=${servicio.idServicio})}" class="btn btn-warning btn-sm">Editar</a>
                            <button type="button" class="btn btn-danger btn-sm js-delete"
                                    th:data-id="${servicio.idServicio}">Eliminar</button>
                        </div>
                        <div sec:authorize="hasRole('CLIENTE')">
                            <a th:href="@{/solicitud/crear/{id}(id=${servicio.idServicio})}" class="btn btn-brand btn-sm">Solicitar</a>
                        </div>
                    </td>
                </tr>
                <tr th:if="${#lists.isEmpty(servicios)}">
                    <td colspan="6" class="text-center text-muted">No se encontraron servicios</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<!-- Modal Confirmación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius:16px; overflow:hidden;">
            <div class="modal-header border-0" style="background:#DFD3C3;">
                <h5 id="confirmDeleteTitle" class="modal-title" style="color:#3b2f2f; font-weight:700;">¿Eliminar servicio?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body" style="background:#F8EDE3; color:#3b2f2f;">
                <p class="mb-0">Esta acción no se puede deshacer. ¿Deseas continuar?</p>
            </div>
            <div class="modal-footer border-0" style="background:#F8EDE3;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form id="confirmDeleteForm" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <button type="submit" class="btn btn-brand text-white">Sí, eliminar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script -->
<script>
    (function(){
      // Modal
      const modalEl = document.getElementById('confirmDeleteModal');
      const form = document.getElementById('confirmDeleteForm');
      if(modalEl && form){
        const modal = new bootstrap.Modal(modalEl);
        document.querySelectorAll('.js-delete').forEach(btn => {
          btn.addEventListener('click', () => {
            form.setAttribute('action', '/servicio/eliminar/' + btn.getAttribute('data-id'));
            modal.show();
          });
        });
      }

      // Filtro
      const input = document.getElementById('buscar');
      const table = document.getElementById('tablaServicios');
      if(!input || !table) return;
      const rows = table.querySelectorAll('tbody tr');
      input.addEventListener('input', e => {
        const q = e.target.value.toLowerCase();
        let any = false;
        rows.forEach(r => {
          if(r.querySelectorAll('td').length){
            const t = r.textContent.toLowerCase();
            const match = t.includes(q);
            r.style.display = match ? '' : 'none';
            if(match) any = true;
          }
        });
      });
    })();
</script>

</body>
</html>
